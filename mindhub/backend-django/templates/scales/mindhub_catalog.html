{% extends 'base/mindhub_base.html' %}

{% block title %}Catálogo de Escalas - MindHub{% endblock %}

{% block content %}
<div class="animate-fade-in" x-data="catalogData()">
    
    <!-- Header de página -->
    <div class="page-header">
        <h1 class="page-title">Clinimetrix - Catálogo de Escalas</h1>
        <p class="page-description">Explora nuestra colección de instrumentos de evaluación psicométrica validados</p>
    </div>

    <!-- Compact Search and Filters -->
    <div class="catalog-search-section">
        <form method="get" class="search-form">
            <div class="search-row">
                <!-- Search Input -->
                <div class="search-input-group">
                    <i data-lucide="search" class="search-icon"></i>
                    <input type="text" 
                           id="search" 
                           name="search" 
                           class="search-input" 
                           placeholder="Buscar escalas, etiquetas, DSM..." 
                           value="{{ search_query }}"
                           x-model="search"
                           @input.debounce.300ms="updateResults()">
                </div>
                
                <!-- Filters -->
                <select id="category" name="category" class="filter-select" x-model="category" @change="updateResults()">
                    <option value="">Todas las categorías</option>
                    {% for cat in categories %}
                        <option value="{{ cat.name }}" {% if cat.name == selected_category %}selected{% endif %}>
                            {{ cat.name }}
                        </option>
                    {% endfor %}
                </select>
                
                <select id="population" name="population" class="filter-select" x-model="population" @change="updateResults()">
                    <option value="">Población</option>
                    <option value="adult" {% if selected_population == 'adult' %}selected{% endif %}>Adultos</option>
                    <option value="adolescent" {% if selected_population == 'adolescent' %}selected{% endif %}>Adolescentes</option>
                    <option value="child" {% if selected_population == 'child' %}selected{% endif %}>Niños</option>
                    <option value="elderly" {% if selected_population == 'elderly' %}selected{% endif %}>Adultos mayores</option>
                </select>
                
                
                <!-- Action Buttons -->
                <button type="submit" class="btn btn-solid-primary btn-sm hover-lift">
                    <span x-show="!loading">
                        <i data-lucide="search" class="w-4 h-4"></i>
                        Filtrar
                    </span>
                    <span x-show="loading" class="flex items-center gap-2">
                        <div class="spinner w-4 h-4"></div>
                        Buscando...
                    </span>
                </button>
                
                <a href="{% url 'scales:catalog' %}" class="btn btn-solid-secondary btn-sm hover-lift" @click="clearFilters()">
                    <i data-lucide="x" class="w-4 h-4"></i>
                    Limpiar
                </a>
            </div>
        </form>
    </div>

    <!-- Results Header with View Controls -->
    <div class="results-section">
        <div class="results-header">
            <div class="results-info">
                <h2 class="results-title">
                    {% if search_query or selected_category or selected_population %}
                        Resultados de búsqueda
                    {% else %}
                        Catálogo de escalas
                    {% endif %}
                </h2>
                <span class="results-count">{{ scales|length }} escala{{ scales|length|pluralize:"s" }} encontrada{{ scales|length|pluralize:"s" }}</span>
            </div>
            
            <!-- View Toggle -->
            <div class="view-controls">
                <button @click="viewMode = 'cards'" 
                        :class="{ 'active': viewMode === 'cards' }"
                        class="view-btn">
                    <i data-lucide="grid-3x3" class="w-4 h-4"></i>
                    <span>Tarjetas</span>
                </button>
                <button @click="viewMode = 'list'" 
                        :class="{ 'active': viewMode === 'list' }"
                        class="view-btn">
                    <i data-lucide="list" class="w-4 h-4"></i>
                    <span>Lista</span>
                </button>
            </div>
        </div>

        {% if scales %}
            <!-- Indicador de filtro activo -->
            <div id="active-filter-indicator" 
                 class="active-filter-banner" 
                 style="display: none;"
                 x-show="activeTagFilter">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 3H2l8 9.46V19l4 2v-8.54L22 3z"></path>
                        </svg>
                        <span class="text-sm font-medium">Filtrando por:</span>
                        <span class="text-sm font-semibold" x-text="activeTagName"></span>
                    </div>
                    <button @click="clearTagFilter()" 
                            class="text-sm text-gray-500 hover:text-gray-700 flex items-center gap-1">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 6L6 18M6 6l12 12"></path>
                        </svg>
                        Limpiar filtro
                    </button>
                </div>
            </div>
            
            <!-- Cards View -->
            <div x-show="viewMode === 'cards'" class="scales-cards-grid">
                {% for scale in scales %}
                    <div class="scale-card hover-lift" 
                         x-data="{ expanded: false }"
                         data-tags="{% for tag in scale.tags.all %}{{ tag.slug }} {% endfor %}"
                         data-scale-id="{{ scale.id }}">
                        <!-- Abstract Image Identifier -->
                        <div class="scale-image" style="background: linear-gradient(135deg, 
                            {% cycle '#667eea, #764ba2' '#f093fb, #f5576c' '#4facfe, #00f2fe' '#43e97b, #38f9d7' '#fa709a, #fee140' '#a8edea, #fed6e3' '#d299c2, #fef9d7' '#89f7fe, #66a6ff' '#ffecd2, #fcb69f' '#ff9a8b, #a8edea' as gradient %});">
                            <div class="scale-pattern"></div>
                            <div class="scale-abbreviation">{{ scale.abbreviation }}</div>
                        </div>
                        
                        <!-- Card Content -->
                        <div class="scale-card-content">
                            <!-- Header with Tags -->
                            <div class="scale-header">
                                <h3 class="scale-title">{{ scale.name }}</h3>
                                <div class="scale-tags">
                                    <!-- Tags reales de la escala - clickeables -->
                                    {% for tag in scale.tags.all %}
                                        <button class="tag tag-clickable" 
                                                style="background-color: {{ tag.color }}15; color: {{ tag.color }}; border-color: {{ tag.color }}25;"
                                                @click="filterByTag('{{ tag.slug }}', '{{ tag.name }}')"
                                                type="button">
                                            {{ tag.name }}
                                        </button>
                                    {% endfor %}
                                    
                                    <!-- Botón para agregar más tags -->
                                    <button class="tag-add-btn" type="button" title="Agregar tag personalizado" @click="openTagModal('{{ scale.id }}')">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M12 5v14m7-7H5"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Description -->
                            <div class="scale-description">
                                <p x-show="!expanded">{{ scale.description|truncatewords:12 }}</p>
                                <p x-show="expanded" x-transition>{{ scale.description }}</p>
                                {% if scale.description|wordcount > 12 %}
                                    <button @click="expanded = !expanded" class="expand-btn">
                                        <span x-show="!expanded">Ver más</span>
                                        <span x-show="expanded">Ver menos</span>
                                    </button>
                                {% endif %}
                            </div>
                            
                            <!-- Stats -->
                            <div class="scale-stats">
                                <div class="stat">
                                    <i data-lucide="clock" class="w-3 h-3"></i>
                                    <span>{{ scale.estimated_duration_minutes }}min</span>
                                </div>
                                <div class="stat">
                                    <i data-lucide="list" class="w-3 h-3"></i>
                                    <span>{{ scale.total_items }} ítems</span>
                                </div>
                            </div>
                            
                            <!-- Actions -->
                            <div class="scale-actions">
                                <a href="{% url 'scales:detail' scale.pk %}" class="btn btn-solid-secondary btn-sm">
                                    <i data-lucide="eye" class="w-4 h-4"></i>
                                    Detalles
                                </a>
                                <a href="{% url 'scales:start_assessment' scale.pk %}" class="btn btn-solid-primary btn-sm">
                                    <i data-lucide="play" class="w-4 h-4"></i>
                                    Usar
                                </a>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            
            <!-- List View -->
            <div x-show="viewMode === 'list'" class="scales-list-view" x-transition>
                {% for scale in scales %}
                    <div class="scale-list-item hover-lift" 
                         data-tags="{% for tag in scale.tags.all %}{{ tag.slug }} {% endfor %}"
                         data-scale-id="{{ scale.id }}">
                        <!-- Image Identifier -->
                        <div class="scale-list-image" style="background: linear-gradient(135deg, 
                            {% cycle '#667eea, #764ba2' '#f093fb, #f5576c' '#4facfe, #00f2fe' '#43e97b, #38f9d7' '#fa709a, #fee140' '#a8edea, #fed6e3' '#d299c2, #fef9d7' '#89f7fe, #66a6ff' '#ffecd2, #fcb69f' '#ff9a8b, #a8edea' as gradient %});">
                            <span class="scale-list-abbreviation">{{ scale.abbreviation }}</span>
                        </div>
                        
                        <!-- Content -->
                        <div class="scale-list-content">
                            <div class="scale-list-main">
                                <h4 class="scale-list-title">{{ scale.name }}</h4>
                                <p class="scale-list-description">{{ scale.description|truncatewords:20 }}</p>
                                
                                <!-- Tags dinámicos clickeables -->
                                <div class="scale-list-tags">
                                    <!-- Tags reales de la escala - clickeables -->
                                    {% for tag in scale.tags.all %}
                                        <button class="tag-list tag-clickable" 
                                                style="background-color: {{ tag.color }}15; color: {{ tag.color }}; border-color: {{ tag.color }}25;"
                                                @click="filterByTag('{{ tag.slug }}', '{{ tag.name }}')"
                                                type="button">
                                            {{ tag.name }}
                                        </button>
                                    {% endfor %}
                                    
                                    <!-- Botón para agregar más tags -->
                                    <button class="tag-add-btn-list" type="button" title="Agregar tag personalizado" @click="openTagModal('{{ scale.id }}')">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M12 5v14m7-7H5"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Stats and Actions -->
                            <div class="scale-list-meta">
                                <div class="scale-list-stats">
                                    <span class="meta-item">
                                        <i data-lucide="clock" class="w-3 h-3"></i>
                                        {{ scale.estimated_duration_minutes }}min
                                    </span>
                                    <span class="meta-item">
                                        <i data-lucide="list" class="w-3 h-3"></i>
                                        {{ scale.total_items }} ítems
                                    </span>
                                </div>
                                
                                <div class="scale-list-actions">
                                    <a href="{% url 'scales:detail' scale.pk %}" class="btn btn-solid-secondary btn-xs">
                                        <i data-lucide="eye" class="w-3 h-3"></i>
                                        Ver
                                    </a>
                                    <a href="{% url 'scales:start_assessment' scale.pk %}" class="btn btn-solid-primary btn-xs">
                                        <i data-lucide="play" class="w-3 h-3"></i>
                                        Usar
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if is_paginated %}
                <div class="mt-8 flex justify-center">
                    <nav class="flex gap-2 items-center">
                        {% if page_obj.has_previous %}
                            <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_population %}&population={{ selected_population }}{% endif %}" 
                               class="btn btn-outline btn-sm hover-lift">Primera</a>
                            <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_population %}&population={{ selected_population }}{% endif %}" 
                               class="btn btn-outline btn-sm hover-lift">← Anterior</a>
                        {% endif %}

                        <span class="px-4 py-2 text-sm text-gray-600">
                            Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                        </span>

                        {% if page_obj.has_next %}
                            <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_population %}&population={{ selected_population }}{% endif %}" 
                               class="btn btn-outline btn-sm hover-lift">Siguiente →</a>
                            <a href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_population %}&population={{ selected_population }}{% endif %}" 
                               class="btn btn-outline btn-sm hover-lift">Última</a>
                        {% endif %}
                    </nav>
                </div>
            {% endif %}
        {% else %}
            <div class="empty-state">
                <div class="empty-icon">
                    <i data-lucide="search" class="w-12 h-12 mx-auto opacity-50"></i>
                </div>
                <h3>No se encontraron escalas</h3>
                <p>Intenta ajustar los filtros de búsqueda para encontrar escalas que coincidan con tus criterios.</p>
                <a href="{% url 'scales:catalog' %}" class="btn btn-primary hover-lift">Ver todas las escalas</a>
            </div>
        {% endif %}
    </div>
    
    <!-- Modal para agregar tags personalizados -->
    <div x-show="showTagModal" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="tag-modal" 
         style="display: none;">
        <div @click.away="closeTagModal()" 
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
             x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
             x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
             class="tag-modal-content">
            <div class="tag-modal-header">
                <h3 class="tag-modal-title">Agregar Tags</h3>
                <p class="tag-modal-description">Selecciona tags existentes o crea uno personalizado para esta escala.</p>
            </div>
            
            <!-- Tags existentes del sistema -->
            <div class="tag-input-group">
                <label class="block text-sm font-medium text-gray-700 mb-2">Tags Disponibles</label>
                <div class="existing-tags-container">
                    {% for tag in tags %}
                        <button type="button"
                                class="existing-tag-option"
                                :class="{ 'selected': selectedExistingTags.includes('{{ tag.slug }}') }"
                                @click="toggleExistingTag('{{ tag.slug }}', '{{ tag.name }}', '{{ tag.color }}')"
                                style="background-color: {{ tag.color }}15; color: {{ tag.color }}; border-color: {{ tag.color }}25;">
                            {{ tag.name }}
                        </button>
                    {% endfor %}
                </div>
            </div>
            
            <div class="divider-or">
                <span>O crea uno personalizado</span>
            </div>
            
            <div class="tag-input-group">
                <label class="block text-sm font-medium text-gray-700 mb-2">Nombre del Tag Personalizado</label>
                <input type="text" 
                       x-model="newTagName" 
                       class="tag-input" 
                       placeholder="Ej: Mi favorita, Urgente, etc."
                       maxlength="20">
            </div>
            
            <div class="tag-input-group">
                <label class="block text-sm font-medium text-gray-700 mb-2">Color para Tag Personalizado</label>
                <div class="tag-color-picker">
                    <div class="color-option" 
                         style="background: #EF4444" 
                         :class="{ 'selected': selectedColor === '#EF4444' }"
                         @click="selectedColor = '#EF4444'"></div>
                    <div class="color-option" 
                         style="background: #3B82F6" 
                         :class="{ 'selected': selectedColor === '#3B82F6' }"
                         @click="selectedColor = '#3B82F6'"></div>
                    <div class="color-option" 
                         style="background: #10B981" 
                         :class="{ 'selected': selectedColor === '#10B981' }"
                         @click="selectedColor = '#10B981'"></div>
                    <div class="color-option" 
                         style="background: #F59E0B" 
                         :class="{ 'selected': selectedColor === '#F59E0B' }"
                         @click="selectedColor = '#F59E0B'"></div>
                    <div class="color-option" 
                         style="background: #8B5CF6" 
                         :class="{ 'selected': selectedColor === '#8B5CF6' }"
                         @click="selectedColor = '#8B5CF6'"></div>
                    <div class="color-option" 
                         style="background: #EC4899" 
                         :class="{ 'selected': selectedColor === '#EC4899' }"
                         @click="selectedColor = '#EC4899'"></div>
                    <div class="color-option" 
                         style="background: #6B7280" 
                         :class="{ 'selected': selectedColor === '#6B7280' }"
                         @click="selectedColor = '#6B7280'"></div>
                </div>
            </div>
            
            <div class="tag-modal-actions">
                <button @click="closeTagModal()" class="btn-modal btn-modal-cancel">
                    Cancelar
                </button>
                <button @click="saveTags()" class="btn-modal btn-modal-save" :disabled="!newTagName.trim() && selectedExistingTags.length === 0">
                    Guardar Tags
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function catalogData() {
    return {
        search: '{{ search_query }}',
        category: '{{ selected_category }}',
        population: '{{ selected_population }}',
        loading: false,
        viewMode: 'cards',
        activeTagFilter: null,
        activeTagName: '',
        showTagModal: false,
        newTagName: '',
        selectedColor: '#3B82F6',
        currentScaleId: null,
        selectedExistingTags: [],
        existingTagsData: {},
        userTags: JSON.parse(localStorage.getItem('userTags') || '{}'),
        
        init() {
            console.log('Catálogo Clinimetrix cargado');
        },
        
        updateResults() {
            this.loading = true;
            setTimeout(() => {
                this.loading = false;
            }, 500);
        },
        
        clearFilters() {
            this.search = '';
            this.category = '';
            this.population = '';
            this.clearTagFilter();
            this.updateResults();
        },
        
        filterByTag(tagSlug, tagName) {
            console.log('Filtrando por tag:', tagName);
            this.activeTagFilter = tagSlug;
            this.activeTagName = tagName;
            
            // Ocultar todos los elementos (tanto tarjetas como lista)
            const allCards = document.querySelectorAll('.scale-card');
            const allListItems = document.querySelectorAll('.scale-list-item');
            
            allCards.forEach(card => {
                card.style.display = 'none';
            });
            
            allListItems.forEach(item => {
                item.style.display = 'none';
            });
            
            // Mostrar solo los elementos que tienen esta tag
            const matchingElements = document.querySelectorAll(`[data-tags*="${tagSlug}"]`);
            matchingElements.forEach(element => {
                element.style.display = element.classList.contains('scale-card') ? 'block' : 'flex';
            });
            
            // Mostrar indicador de filtro activo
            this.showActiveFilter();
        },
        
        clearTagFilter() {
            this.activeTagFilter = null;
            this.activeTagName = '';
            
            // Mostrar todos los elementos (tanto tarjetas como lista)
            const allCards = document.querySelectorAll('.scale-card');
            const allListItems = document.querySelectorAll('.scale-list-item');
            
            allCards.forEach(card => {
                card.style.display = 'block';
            });
            
            allListItems.forEach(item => {
                item.style.display = 'flex';
            });
            
            // Ocultar indicador de filtro
            this.hideActiveFilter();
        },
        
        showActiveFilter() {
            const filterIndicator = document.getElementById('active-filter-indicator');
            if (filterIndicator) {
                filterIndicator.style.display = 'flex';
            }
        },
        
        hideActiveFilter() {
            const filterIndicator = document.getElementById('active-filter-indicator');
            if (filterIndicator) {
                filterIndicator.style.display = 'none';
            }
        },
        
        openTagModal(scaleId) {
            this.currentScaleId = scaleId;
            this.newTagName = '';
            this.selectedColor = '#3B82F6';
            this.selectedExistingTags = [];
            this.showTagModal = true;
            console.log('Abriendo modal para escala:', scaleId);
        },
        
        closeTagModal() {
            this.showTagModal = false;
            this.currentScaleId = null;
            this.newTagName = '';
            this.selectedColor = '#3B82F6';
            this.selectedExistingTags = [];
        },
        
        toggleExistingTag(slug, name, color) {
            const index = this.selectedExistingTags.indexOf(slug);
            if (index > -1) {
                this.selectedExistingTags.splice(index, 1);
                delete this.existingTagsData[slug];
            } else {
                this.selectedExistingTags.push(slug);
                this.existingTagsData[slug] = { name, color };
            }
        },
        
        saveTags() {
            if (!this.currentScaleId) return;
            if (this.selectedExistingTags.length === 0 && !this.newTagName.trim()) return;
            
            let tagsAdded = [];
            
            // Agregar tags existentes seleccionados
            if (this.selectedExistingTags.length > 0) {
                this.selectedExistingTags.forEach(slug => {
                    const tagData = this.existingTagsData[slug];
                    if (tagData) {
                        const tag = {
                            id: slug,
                            name: tagData.name,
                            color: tagData.color,
                            isSystem: true
                        };
                        this.addTagToScale(this.currentScaleId, tag);
                        tagsAdded.push(tagData.name);
                    }
                });
            }
            
            // Agregar tag personalizado si existe
            if (this.newTagName.trim()) {
                const tagId = Date.now().toString();
                const newTag = {
                    id: tagId,
                    name: this.newTagName.trim(),
                    color: this.selectedColor,
                    isSystem: false
                };
                
                // Guardar en localStorage del usuario
                if (!this.userTags[this.currentScaleId]) {
                    this.userTags[this.currentScaleId] = [];
                }
                this.userTags[this.currentScaleId].push(newTag);
                localStorage.setItem('userTags', JSON.stringify(this.userTags));
                
                this.addTagToScale(this.currentScaleId, newTag);
                tagsAdded.push(newTag.name);
            }
            
            // Mostrar notificación
            if (tagsAdded.length > 0) {
                const message = tagsAdded.length === 1 
                    ? `Tag "${tagsAdded[0]}" agregado exitosamente`
                    : `${tagsAdded.length} tags agregados exitosamente`;
                this.showNotification(message);
            }
            
            this.closeTagModal();
        },
        
        addTagToScale(scaleId, tag) {
            // Encontrar la escala y agregar el tag
            const scaleCards = document.querySelectorAll(`[data-scale-id="${scaleId}"]`);
            scaleCards.forEach(scaleElement => {
                const isListView = scaleElement.classList.contains('scale-list-item');
                const tagsContainer = scaleElement.querySelector('.scale-tags, .scale-list-tags');
                
                if (tagsContainer) {
                    // Verificar si el tag ya existe
                    const existingTag = tagsContainer.querySelector(`[data-tag-id="${tag.id}"]`);
                    if (existingTag) return; // Si ya existe, no agregar duplicado
                    
                    const tagButton = document.createElement('button');
                    // Usar clases apropiadas según la vista
                    if (isListView) {
                        tagButton.className = 'tag-list tag-clickable';
                    } else {
                        tagButton.className = 'tag tag-clickable';
                    }
                    tagButton.style.cssText = `background-color: ${tag.color}15; color: ${tag.color}; border-color: ${tag.color}25;`;
                    tagButton.textContent = tag.name;
                    tagButton.setAttribute('data-tag-id', tag.id);
                    tagButton.onclick = () => {
                        if (tag.isSystem) {
                            this.filterByTag(tag.id, tag.name);
                        } else {
                            this.filterByCustomTag(tag.id, tag.name);
                        }
                    };
                    
                    // Insertar antes del botón +
                    const addButton = tagsContainer.querySelector('.tag-add-btn, .tag-add-btn-list');
                    if (addButton) {
                        tagsContainer.insertBefore(tagButton, addButton);
                    }
                }
            });
        },
        
        filterByCustomTag(tagId, tagName) {
            console.log('Filtrando por tag personalizado:', tagName);
            this.activeTagFilter = tagId;
            this.activeTagName = tagName;
            
            // Encontrar escalas que tienen este tag
            const scalesWithTag = [];
            Object.entries(this.userTags).forEach(([scaleId, tags]) => {
                if (tags.some(tag => tag.id === tagId)) {
                    scalesWithTag.push(scaleId);
                }
            });
            
            // Ocultar todos los elementos
            const allCards = document.querySelectorAll('.scale-card');
            const allListItems = document.querySelectorAll('.scale-list-item');
            
            allCards.forEach(card => card.style.display = 'none');
            allListItems.forEach(item => item.style.display = 'none');
            
            // Mostrar solo las escalas con este tag
            scalesWithTag.forEach(scaleId => {
                const elements = document.querySelectorAll(`[data-scale-id="${scaleId}"]`);
                elements.forEach(element => {
                    element.style.display = element.classList.contains('scale-card') ? 'block' : 'flex';
                });
            });
            
            this.showActiveFilter();
        },
        
        showNotification(message) {
            // Crear notificación temporal
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    }
}
</script>
{% endblock content %}