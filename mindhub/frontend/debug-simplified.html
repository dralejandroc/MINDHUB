<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§ª Test Arquitectura Simplificada</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            border: 1px solid #e0e0e0;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .info { color: blue; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; }
        .metrics {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ Test Arquitectura Simplificada - MindHub</h1>
        <p>Verifica que la nueva arquitectura ultra-simple funcione correctamente</p>
        
        <div class="metrics">
            <h3>ğŸ“Š MÃ©tricas de SimplificaciÃ³n</h3>
            <div id="metrics">
                <p><strong>ANTES:</strong> 8-10 headers por peticiÃ³n, 5-10 queries DB</p>
                <p><strong>AHORA:</strong> 2 headers, 1 query DB</p>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ” 1. Test AutenticaciÃ³n Simplificada</h3>
            <button onclick="testAuth()">Test JWT Simple</button>
            <div id="auth-result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ‘¥ 2. Test CreaciÃ³n de Paciente</h3>
            <button onclick="testCreatePatient()">Crear Paciente Test</button>
            <div id="create-result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“‹ 3. Test Listado de Pacientes</h3>
            <button onclick="testListPatients()">Listar Pacientes</button>
            <div id="list-result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ” 4. Test BÃºsqueda Simplificada</h3>
            <input id="search-term" placeholder="TÃ©rmino de bÃºsqueda" value="Juan">
            <button onclick="testSearchPatients()">Buscar Pacientes</button>
            <div id="search-result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“ˆ 5. Performance Test</h3>
            <button onclick="performanceTest()">Test Performance</button>
            <div id="performance-result"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api/expedix';
        const MOCK_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJhMWMxOTNlOS02NDNhLTRiYTktOTIxNC0yOTUzNmVhOTM5MTMiLCJlbWFpbCI6ImRyX2FsZWtzX2NAaG90bWFpbC5jb20iLCJyb2xlIjoiYXV0aGVudGljYXRlZCJ9.test';
        
        function logResult(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            const className = isError ? 'error' : 'success';
            element.innerHTML += `<div class="${className}">${new Date().toLocaleTimeString()} - ${message}</div>`;
        }
        
        function logInfo(elementId, message) {
            const element = document.getElementById(elementId);
            element.innerHTML += `<div class="info">${message}</div>`;
        }
        
        async function testAuth() {
            const resultDiv = document.getElementById('auth-result');
            resultDiv.innerHTML = '<p>ğŸ§ª Testing JWT authentication...</p>';
            
            try {
                logInfo('auth-result', 'ğŸ”‘ Token payload: ' + atob(MOCK_TOKEN.split('.')[1]));
                
                const response = await fetch(`${API_BASE}/patients`, {
                    headers: {
                        'Authorization': `Bearer ${MOCK_TOKEN}`
                        // âœ… SOLO 1 HEADER de autenticaciÃ³n
                    }
                });
                
                logInfo('auth-result', `ğŸ“Š Response status: ${response.status}`);
                logInfo('auth-result', `ğŸ“Š Headers count: ${response.headers.entries().length || 'N/A'}`);
                
                if (response.ok) {
                    logResult('auth-result', 'âœ… JWT authentication working!');
                } else {
                    const error = await response.text();
                    logResult('auth-result', `âŒ Auth failed: ${error}`, true);
                }
                
            } catch (error) {
                logResult('auth-result', `ğŸ’¥ Network error: ${error.message}`, true);
            }
        }
        
        async function testCreatePatient() {
            const resultDiv = document.getElementById('create-result');
            resultDiv.innerHTML = '<p>ğŸ§ª Testing patient creation...</p>';
            
            const testPatient = {
                first_name: 'Juan Carlos',
                paternal_last_name: 'PÃ©rez',
                maternal_last_name: 'GarcÃ­a',
                email: `test.${Date.now()}@mindhub.test`,
                cell_phone: '+52 555 123 4567',
                birth_date: '1985-06-15',
                gender: 'male',
                age: 38
            };
            
            const startTime = performance.now();
            
            try {
                const response = await fetch(`${API_BASE}/patients/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${MOCK_TOKEN}`
                        // âœ… SOLO 2 HEADERS - arquitectura simplificada!
                    },
                    body: JSON.stringify(testPatient)
                });
                
                const endTime = performance.now();
                const responseTime = Math.round(endTime - startTime);
                
                logInfo('create-result', `â±ï¸ Response time: ${responseTime}ms`);
                logInfo('create-result', `ğŸ“Š Status: ${response.status}`);
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    logResult('create-result', `âœ… Patient created successfully! ID: ${result.data.id}`);
                    logInfo('create-result', `<pre>${JSON.stringify(result.data, null, 2)}</pre>`);
                } else {
                    logResult('create-result', `âŒ Creation failed: ${JSON.stringify(result)}`, true);
                }
                
            } catch (error) {
                logResult('create-result', `ğŸ’¥ Network error: ${error.message}`, true);
            }
        }
        
        async function testListPatients() {
            const resultDiv = document.getElementById('list-result');
            resultDiv.innerHTML = '<p>ğŸ§ª Testing patient listing...</p>';
            
            const startTime = performance.now();
            
            try {
                const response = await fetch(`${API_BASE}/patients/`, {
                    headers: {
                        'Authorization': `Bearer ${MOCK_TOKEN}`
                    }
                });
                
                const endTime = performance.now();
                const responseTime = Math.round(endTime - startTime);
                
                logInfo('list-result', `â±ï¸ Response time: ${responseTime}ms`);
                
                if (response.ok) {
                    const result = await response.json();
                    const count = result.total || result.data?.length || 0;
                    logResult('list-result', `âœ… Patient listing successful! Count: ${count}`);
                    
                    if (result.data && result.data.length > 0) {
                        logInfo('list-result', `ğŸ“ Sample patient: ${result.data[0].first_name} ${result.data[0].paternal_last_name}`);
                    }
                } else {
                    const error = await response.text();
                    logResult('list-result', `âŒ Listing failed: ${error}`, true);
                }
                
            } catch (error) {
                logResult('list-result', `ğŸ’¥ Network error: ${error.message}`, true);
            }
        }
        
        async function testSearchPatients() {
            const resultDiv = document.getElementById('search-result');
            const searchTerm = document.getElementById('search-term').value;
            resultDiv.innerHTML = `<p>ğŸ§ª Testing patient search for: "${searchTerm}"...</p>`;
            
            const startTime = performance.now();
            
            try {
                const response = await fetch(`${API_BASE}/patients/?search=${encodeURIComponent(searchTerm)}`, {
                    headers: {
                        'Authorization': `Bearer ${MOCK_TOKEN}`
                    }
                });
                
                const endTime = performance.now();
                const responseTime = Math.round(endTime - startTime);
                
                logInfo('search-result', `â±ï¸ Response time: ${responseTime}ms`);
                
                if (response.ok) {
                    const result = await response.json();
                    const count = result.total || result.data?.length || 0;
                    logResult('search-result', `âœ… Search successful! Found: ${count} patients`);
                    
                    if (result.data && result.data.length > 0) {
                        result.data.forEach(patient => {
                            logInfo('search-result', `ğŸ‘¤ ${patient.first_name} ${patient.paternal_last_name} (${patient.email})`);
                        });
                    }
                } else {
                    const error = await response.text();
                    logResult('search-result', `âŒ Search failed: ${error}`, true);
                }
                
            } catch (error) {
                logResult('search-result', `ğŸ’¥ Network error: ${error.message}`, true);
            }
        }
        
        async function performanceTest() {
            const resultDiv = document.getElementById('performance-result');
            resultDiv.innerHTML = '<p>ğŸ§ª Running performance test...</p>';
            
            const tests = [
                { name: 'List patients', url: `${API_BASE}/patients/` },
                { name: 'Search patients', url: `${API_BASE}/patients/?search=test` },
            ];
            
            const results = [];
            
            for (const test of tests) {
                const startTime = performance.now();
                
                try {
                    const response = await fetch(test.url, {
                        headers: {
                            'Authorization': `Bearer ${MOCK_TOKEN}`
                        }
                    });
                    
                    const endTime = performance.now();
                    const responseTime = Math.round(endTime - startTime);
                    
                    results.push({
                        name: test.name,
                        time: responseTime,
                        status: response.status,
                        success: response.ok
                    });
                    
                    logInfo('performance-result', `${test.name}: ${responseTime}ms (${response.status})`);
                    
                } catch (error) {
                    results.push({
                        name: test.name,
                        time: -1,
                        status: 'ERROR',
                        success: false,
                        error: error.message
                    });
                    
                    logResult('performance-result', `${test.name}: ERROR - ${error.message}`, true);
                }
            }
            
            const avgTime = results.filter(r => r.time > 0).reduce((sum, r) => sum + r.time, 0) / results.length;
            const successRate = (results.filter(r => r.success).length / results.length) * 100;
            
            logResult('performance-result', `ğŸ“ˆ Average response time: ${Math.round(avgTime)}ms`);
            logResult('performance-result', `âœ… Success rate: ${successRate}%`);
            
            if (avgTime < 200) {
                logResult('performance-result', 'ğŸš€ EXCELLENT performance with simplified architecture!');
            } else if (avgTime < 500) {
                logResult('performance-result', 'âœ… Good performance with simplified architecture');
            } else {
                logResult('performance-result', 'âš ï¸ Performance could be improved', true);
            }
        }
        
        // Auto-run basic test on page load
        setTimeout(() => {
            document.getElementById('metrics').innerHTML += '<p><strong>ğŸ§ª Auto-testing arquitectura simplificada...</strong></p>';
        }, 1000);
    </script>
</body>
</html>